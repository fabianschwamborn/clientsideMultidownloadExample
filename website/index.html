<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side Multi-Download Technology Demonstrator</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Client-Side Multi-Download Technology Demonstrator</h1>
        
        <div class="info-box" style="background: linear-gradient(135deg, #f0f7ff 0%, #e8f4f8 100%); border-left: 4px solid #0066cc; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,102,204,0.1);">
            <p style="margin: 0 0 12px 0; font-size: 16px; color: #0066cc;"><strong>üí° What does this do?</strong></p>
            <p style="margin: 0 0 15px 0; font-size: 14px; line-height: 1.6; color: #333;">
                This application demonstrates client-side file download capabilities:
            </p>
            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 2;">
                    <li style="margin-bottom: 8px;">
                        üìã Fetches a file list from a remote server 
                        (<a href="https://testfiles.xxip.de/index.txt" target="_blank" style="color: #2196F3; text-decoration: none; border-bottom: 1px dotted #2196F3;">https://testfiles.xxip.de/index.txt</a>)
                    </li>
                    <li style="margin-bottom: 8px;">‚úÖ Offers a user-friendly interface for selecting files (could be changed to automatically download a server-side generated file list)</li>
                    <li style="margin-bottom: 4px;">üì¶ When downloading:</li>
                </ul>
                <ul style="margin: 8px 0 0 40px; padding-left: 20px; font-size: 14px; line-height: 1.9; color: #555;">
                    <li style="margin-bottom: 6px;">üè∑Ô∏è Automatically renames files with prefixes (single & multiple files)</li>
                    <li style="margin-bottom: 6px;">üóúÔ∏è Bundles multiple selected files into ZIP archives</li>
                    <li style="margin-bottom: 6px;">‚ö° Uses modern streaming APIs for memory efficiency</li>
                    <li style="margin-bottom: 0;"><strong style="color: #0066cc;">üöÄ No backend required</strong> ‚Äì all logic runs in your browser!</li>
                </ul>
            </div>
            <div style="background: rgba(255,255,255,0.6); padding: 12px; border-radius: 6px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; font-size: 14px;">
                <span style="display: flex; align-items: center; gap: 6px;">
                    üì¶ <strong>Repository:</strong> 
                    <a href="https://github.com/fabianschwamborn/clientsideMultidownloadExample" target="_blank" style="color: #2196F3; text-decoration: none; font-weight: bold; border-bottom: 2px solid transparent; transition: border-bottom 0.2s;" onmouseover="this.style.borderBottom='2px solid #2196F3'" onmouseout="this.style.borderBottom='2px solid transparent'">
                        GitHub
                    </a>
                </span>
            </div>
            <div style="border-top: 1px solid rgba(0, 102, 204, 0.2); padding-top: 12px; margin-top: 12px;">
                <p style="margin: 0 0 8px 0; font-size: 15px; cursor: pointer;" onclick="toggleInfoBox(this)">
                    <strong>üî¨ Demonstrated Technologies</strong> <span style="font-size: 13px; color: #666;">‚ñº Click to expand</span>
                </p>
                <div class="info-box-content collapsed">
                    <p style="margin: 5px 0 8px 0; font-size: 14px;">This project demonstrates advanced client-side browser capabilities:</p>
                <ul>
                    <li><strong>Stream Processing:</strong> Memory-efficient handling of large files using ReadableStream API</li>
                    <li><strong>On-the-fly ZIP Compression:</strong> Real-time file packing with fflate library</li>
                    <li><strong>File Renaming:</strong> Automatic "singlefile_" prefix for single files, "batchload_" prefix for multiple files in ZIP</li>
                    <li><strong>Download Streaming:</strong> Direct-to-disk writing via StreamSaver.js or File System Access API</li>
                    <li><strong>Single File Optimization:</strong> Bypasses ZIP creation for single file downloads (direct streaming)</li>
                    <li><strong>Intelligent Fallback:</strong> Automatic method selection: File System API ‚Üí StreamSaver ‚Üí Blob</li>
                    <li><strong>User Control:</strong> Manual download method selection and force fallback option</li>
                    <li><strong>Page Protection:</strong> Prevents accidental closure during active downloads</li>
                </ul>
                <div class="not-implemented" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin-top: 12px; font-size: 13px;">
                    <strong>üí° Fallback Strategy Discussion:</strong> The current blob fallback method (used when streaming fails) has high memory usage and may fail with large files. An alternative approach is to skip ZIP creation entirely in fallback scenarios and instead download each file individually with direct browser downloads. This would eliminate memory constraints and improve reliability for large batch downloads, though users would receive multiple separate files instead of a single ZIP archive. <strong>Important CORS limitation:</strong> Due to browser security policies, cross-origin downloads cannot be renamed via the <code>download</code> attribute‚Äîfiles will retain their original names instead of receiving sequential prefixes like <code>batchload_001_filename.ext</code>. To enable file renaming, files would need to be loaded into memory (blob), which defeats the purpose of this low-memory fallback strategy. The current implementation prioritizes reliability over naming consistency for cross-origin batch downloads.
                </div>
                <div class="not-implemented" style="font-size: 13px;">
                    <strong>‚ö†Ô∏è Not Yet Implemented:</strong> Page-independent service worker for background downloads (would allow page navigation during download)
                </div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading file list...</div>
        <div id="fileListContainer" style="display: none;">
            <div id="fileList" class="file-list"></div>
            
            <div class="download-options">
                <h3 class="collapsed" onclick="toggleDownloadOptions(this)">‚öôÔ∏è Download Options</h3>
                <div class="download-options-content collapsed">
                <label class="option-label">
                    <input type="checkbox" id="useFileSystemAPI" checked>
                    <span>Use File System Access API (Ask where to save)</span>
                </label>
                <p class="option-description">
                    When enabled and available, shows a dialog to choose where to save the file.
                    When disabled or unavailable, starts streaming download directly.
                </p>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #495057; font-size: 15px;">Blob Fallback Strategy</h4>
                    <p class="option-description" style="margin-left: 0; margin-bottom: 15px;">
                        If streaming methods fail or are unavailable, the system will use blob fallback. Choose your preferred strategy:
                    </p>
                    
                    <label class="option-label">
                        <input type="radio" name="blobFallbackMode" value="no-fallback">
                        <span>Download files individually (no ZIP) - Safest option</span>
                    </label>
                    <p class="option-description">
                        Downloads each file separately with prefix fallback_1_, fallback_2_, etc.
                        Avoids memory issues completely. Recommended for large batches.
                    </p>
                    
                    <label class="option-label">
                        <input type="radio" name="blobFallbackMode" value="auto-fallback" checked>
                        <span>Automatic: Individual if &gt; 101 MiB, otherwise ZIP</span>
                    </label>
                    <p class="option-description">
                        Smart fallback: Uses individual downloads for large batches (&gt;101 MiB total),
                        creates ZIP via blob for smaller batches. Balances convenience and safety.
                    </p>
                    
                    <label class="option-label">
                        <input type="radio" name="blobFallbackMode" value="forced-fallback">
                        <span>Always create ZIP via blob - High memory usage!</span>
                    </label>
                    <p class="option-description">
                        ‚ö†Ô∏è Forces ZIP creation via blob method. May cause browser freeze or crash with large files!
                    </p>
                </div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <label class="option-label">
                        <input type="checkbox" id="forceBlobFallback">
                        <span>Force Blob Fallback (Debug/Testing)</span>
                    </label>
                    <p class="option-description">
                        Forces the use of blob method instead of streaming APIs. Only use for testing or compatibility issues.
                        The blob fallback strategy selected above will be applied.
                    </p>
                </div>
                
                <div id="downloadMethodInfo" class="method-info"></div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn btn-secondary" onclick="selectNone()">Deselect All</button>
                <button id="downloadBtn" class="btn" onclick="downloadSelected()">Download Selected Files</button>
            </div>
        </div>
        <div id="progress" class="progress">
            <div class="progress-container">
                <div class="progress-label">Current File:</div>
                <div class="progress-bar">
                    <div id="currentFileProgressFill" class="progress-fill current-file"></div>
                </div>
                <div id="currentFileProgressText" class="progress-text">-</div>
            </div>
            <div class="progress-container">
                <div class="progress-label">Overall Progress:</div>
                <div class="progress-bar">
                    <div id="overallProgressFill" class="progress-fill overall"></div>
                </div>
                <div id="overallProgressText" class="progress-text">Preparing download...</div>
            </div>
            <div id="blobWarning" class="blob-warning" style="display: none;">
                ‚ö†Ô∏è WARNING: Using Blob method - High memory usage! Large files may cause browser to freeze or crash.
            </div>
        </div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div class="debug-console-wrapper">
            <div class="debug-console-header collapsed" onclick="toggleDebugConsole(this)">
                <span>üêõ Debug Console (Mobile-Friendly debugging)</span>
            </div>
            <div class="debug-console collapsed">
                <div class="debug-controls">
                    <button class="debug-clear" onclick="clearDebugConsole()">Clear</button>
                </div>
                <div id="debugOutput" class="debug-content"></div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>